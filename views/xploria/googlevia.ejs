<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Set Password</title>
    <link rel="stylesheet" type="text/css" href="/css_xploria/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="/css_xploria/fontawesome-all.min.css">
    <link rel="stylesheet" type="text/css" href="/css_xploria/iofrm-style.css">
    <link rel="stylesheet" type="text/css" href="/css_xploria/iofrm-theme15.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <style>
        body { background-color: #0f172a; color: #e5e7eb; }
        .center-wrap { min-height: 100vh; display: flex; align-items: center; justify-content: center; }
        .card-dark { width: 100%; max-width: 420px; background-color: #111827; border: 1px solid #1f2937; border-radius: 18px; box-shadow: 0 10px 30px rgba(0,0,0,.6); padding: 24px; }
        .text-muted-dark { color: #9ca3af; }
        .form-control { background-color: #0b1220; color: #e5e7eb; border: 1px solid #374151; border-radius: 10px; }
        .form-control::placeholder { color: #6b7280; }
        .form-control:focus { background-color: #0b1220; color: #fff; border-color: #2563eb; box-shadow: 0 0 0 .25rem rgba(37,99,235,.25); }
        .btn-primary { background-color: #2563eb; border-color: #2563eb; border-radius: 10px; }
        .btn-primary:hover { background-color: #1d4ed8; border-color: #1d4ed8; }
        .logo-bar { display: flex; justify-content: center; margin-bottom: 16px; }
        .logo-bar .logo-size { height: 56px; width: 56px; }
        .alert { background-color: #1f2937; color: #fca5a5; border: 1px solid #374151; }
    </style>
</head>
<body class="bg-dark">
    <div class="center-wrap">
        <div class="card-dark">
            <div class="logo-bar">
                <a href="/">
                    <img class="logo-size" src="/image_xploria/logo.png" alt="Xploria">
                </a>
            </div>
            <h3 class="mb-2" style="color:#fff;">Set Your Password</h3>
            <p class="mb-3 text-muted-dark">You signed in with Google. Set a password to also login without Google.</p>
            <form id="setPasswordForm">
                <div id="setPassAlert" class="alert d-none" role="alert"></div>
                <input class="form-control mb-2" type="email" name="email" placeholder="E-mail Address" required>
                <input class="form-control mb-3" type="password" name="password" placeholder="New Password" required>
                <button type="submit" class="btn btn-primary w-100">Save Password</button>
            </form>
        </div>
    </div>

    <script>
        // Pre-fill email from localStorage if present
        (function() {
            try {
                const user = JSON.parse(localStorage.getItem('user') || '{}');
                if (user && user.email) {
                    const emailInput = document.querySelector('input[name="email"]');
                    if (emailInput) {
                        emailInput.value = user.email;
                        emailInput.readOnly = true;
                    }
                    // If user already has a password, redirect to success
                    fetch(`/auth/has-password?email=${encodeURIComponent(user.email)}`)
                        .then(r => r.json())
                        .then(d => {
                            if (d && d.success && d.hasPassword) {
                                window.location.href = '/success';
                            }
                        })
                        .catch(() => {});
                }
            } catch (e) {}
        })();

        document.getElementById('setPasswordForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const email = document.querySelector('input[name="email"]').value;
            const password = document.querySelector('input[name="password"]').value;

            try {
                const res = await fetch('/auth/set-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                const data = await res.json();
                if (data.success) {
                    localStorage.setItem('user', JSON.stringify(data.user));
                    window.location.href = '/block';
                } else {
                    const alertBox = document.getElementById('setPassAlert');
                    alertBox.textContent = data.message || 'Failed to set password';
                    alertBox.classList.remove('d-none');
                }
            } catch (err) {
                const alertBox = document.getElementById('setPassAlert');
                alertBox.textContent = 'Error: ' + err.message;
                alertBox.classList.remove('d-none');
            }
        });
    </script>

    <script src="/js_xploria/jquery.min.js"></script>
    <script src="/js_xploria/popper.min.js"></script>
    <script src="/js_xploria/bootstrap.bundle.min.js"></script>
</body>
</html>


