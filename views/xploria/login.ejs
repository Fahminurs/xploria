<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login Iroschool</title>
    <link rel="stylesheet" type="text/css" href="/css_xploria/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="/css_xploria/fontawesome-all.min.css">
    <link rel="stylesheet" type="text/css" href="/css_xploria/iofrm-style.css">
    <link rel="stylesheet" type="text/css" href="/css_xploria/iofrm-theme15.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>

<body>
    <div class="form-body">
        <div class="website-logo">
            <a href="/">
                <div class="logo">
                    <img class="logo-size" src="/image_xploria/logo.png" alt="">
                </div>
            </a>
        </div>
        <div class="iofrm-layout">
            <div class="img-holder">
                <div class="bg"></div>
                <div class="info-holder">
                    <h3>Welcome to Xploria - Your STEM Learning Hub!</h3>
                    <p>Access the most comprehensive educational platform for STEM excellence.<br><br>
                        Continue your learning journey with interactive courses, hands-on projects, and expert guidance. Join thousands of students who are already transforming their future through innovative STEM education.</p>
                </div>
            </div>
            <div class="form-holder">
                <div class="form-content">
                    <div class="form-items">
                        <div class="page-links" id="authTabs">
                            <a href="/login" class="active" data-target="login">Login</a><a href="/register" data-target="register">Register</a>
                        </div>
                        <!-- Login Panel -->
                        <form id="loginForm" data-panel="login">
                            <div id="loginAlert" class="alert alert-danger d-none" role="alert"></div>
                            <input class="form-control" type="email" name="email" placeholder="E-mail Address" required>
                            <input class="form-control" type="password" name="password" placeholder="Password" required>
                            <div class="form-button">
                                <button id="submit" type="submit" class="ibtn mb-3">Login</button> <a
                                    href="/forget">Forget password?</a>
                            </div>
                            <div class="mt-2">
                                <button type="button" class="btn btn-outline-secondary w-100" id="google-login-btn">
                                    <span style="display:inline-flex;align-items:center;gap:.5rem;">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 48 48">
                                            <path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303C33.602,31.91,29.197,35,24,35c-6.627,0-12-5.373-12-12
                                            s5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.869,5.053,29.702,3,24,3C12.955,3,4,11.955,4,23
                                            s8.955,20,20,20c10.493,0,19-8.507,19-19C43,22.659,43.262,21.345,43.611,20.083z"/>
                                            <path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,16.108,18.961,13,24,13c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657
                                            C34.869,5.053,29.702,3,24,3C16.318,3,9.656,7.337,6.306,14.691z"/>
                                            <path fill="#4CAF50" d="M24,43c5.138,0,9.799-1.969,13.285-5.182l-6.14-5.197C29.127,34.205,26.715,35,24,35
                                            c-5.176,0-9.567-3.105-11.289-7.505l-6.53,5.033C9.5,38.556,16.227,43,24,43z"/>
                                            <path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-1.091,3.225-3.33,5.858-6.218,7.621
                                            c0.002-0.001,0.003-0.001,0.005-0.002l6.14,5.197C34.94,41.205,43,36,43,24C43,22.659,43.262,21.345,43.611,20.083z"/>
                                        </svg>
                                        <span>Continue with Google</span>
                                    </span>
                                </button>
                            </div>
                        </form>
                        <!-- Register Panel (hidden for SPA) -->
                        <form id="registerForm" data-panel="register" style="display:none;">
                            <div id="registerAlert" class="alert alert-danger d-none" role="alert"></div>
                            <input class="form-control" type="text" name="name" placeholder="Full Name" required>
                            <input class="form-control" type="email" name="email" placeholder="E-mail Address" required>
                            <input class="form-control" type="password" name="password" placeholder="Password" required>
                            <div class="form-button">
                                <button type="submit" class="btn btn-primary w-100">Register</button>
                            </div>
                            <div class="mt-2">
                                <button type="button" class="btn btn-outline-secondary w-100" id="google-register-btn">
                                    <span style="display:inline-flex;align-items:center;gap:.5rem;">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 48 48">
                                            <path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303C33.602,31.91,29.197,35,24,35c-6.627,0-12-5.373-12-12
                                            s5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.869,5.053,29.702,3,24,3C12.955,3,4,11.955,4,23
                                            s8.955,20,20,20c10.493,0,19-8.507,19-19C43,22.659,43.262,21.345,43.611,20.083z"/>
                                            <path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,16.108,18.961,13,24,13c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657
                                            C34.869,5.053,29.702,3,24,3C16.318,3,9.656,7.337,6.306,14.691z"/>
                                            <path fill="#4CAF50" d="M24,43c5.138,0,9.799-1.969,13.285-5.182l-6.14-5.197C29.127,34.205,26.715,35,24,35
                                            c-5.176,0-9.567-3.105-11.289-7.505l-6.53,5.033C9.5,38.556,16.227,43,24,43z"/>
                                            <path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-1.091,3.225-3.33,5.858-6.218,7.621
                                            c0.002-0.001,0.003-0.001,0.005-0.002l6.14,5.197C34.94,41.205,43,36,43,24C43,22.659,43.262,21.345,43.611,20.083z"/>
                                        </svg>
                                        <span>Register with Google</span>
                                    </span>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                <div class="form-note">
                    <p>Don't have an account? <a href="/register">Register here</a></p>
                </div>
            </div>
        </div>
    </div>
    <!-- Toast Container -->
    <div id="toast-container" style="position: fixed; top: 1rem; right: 1rem; z-index: 9999;"></div>
    <script src="/js_xploria/jquery.min.js"></script>
    <script src="/js_xploria/popper.min.js"></script>
    <script src="/js_xploria/bootstrap.bundle.min.js"></script>
    <script src="/js_xploria/main.js"></script>
    
    <script>
        // SPA tab switching (no reload)
        document.getElementById('authTabs').addEventListener('click', function(e){
            if (e.target.tagName.toLowerCase() === 'a') {
                e.preventDefault();
                const target = e.target.getAttribute('data-target');
                document.querySelectorAll('#authTabs a').forEach(a => a.classList.remove('active'));
                e.target.classList.add('active');
                document.querySelectorAll('form[data-panel]').forEach(f => {
                    f.style.display = f.getAttribute('data-panel') === target ? 'block' : 'none';
                });
            }
        });

        // Google Sign-In Configuration
        const GOOGLE_CLIENT_ID = '109183625335-p5vj03oh9n20joq71vkg5dl4hu44kka6.apps.googleusercontent.com';
        
        // Initialize Google Sign-In
        function initializeGoogleSignIn() {
            if (typeof google !== 'undefined') {
                google.accounts.id.initialize({
                    client_id: GOOGLE_CLIENT_ID,
                    callback: handleCredentialResponse
                });
                
                // Render both buttons so whichever tab is active is ready
                google.accounts.id.renderButton(
                    document.getElementById('google-login-btn'),
                    {
                        type: 'standard',
                        shape: 'rectangular',
                        theme: 'outline',
                        text: 'sign_in_with',
                        size: 'large',
                        logo_alignment: 'left'
                    }
                );
                google.accounts.id.renderButton(
                    document.getElementById('google-register-btn'),
                    {
                        type: 'standard',
                        shape: 'rectangular',
                        theme: 'outline',
                        text: 'signup_with',
                        size: 'large',
                        logo_alignment: 'left'
                    }
                );
            }
        }
        
        // Handle Google Sign-In response
        function handleCredentialResponse(response) {
            if (response.credential) {
                console.log("Google Sign-In successful");
                
                // Send credential to server
                fetch('/auth/google', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ credential: response.credential })
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        localStorage.setItem('user', JSON.stringify(data.user));
                        
                        if (data.needsPasswordSet) {
                            window.location.href = '/googlevia';
                        } else {
                            window.location.href = '/block';
                        }
                    } else {
                        const alertBox = document.getElementById('loginAlert');
                        if (alertBox) {
                            alertBox.textContent = data.message || 'Login failed. Please try again.';
                            alertBox.classList.remove('d-none');
                        }
                    }
                })
                .catch(err => {
                    console.error('Error during login:', err);
                    alert('Login failed: ' + err.message);
                });
            } else {
                console.error("Login failed - no credential received");
                alert('Login failed - no credential received');
            }
        }
        
        // Handle manual login submission
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const email = document.querySelector('input[name="email"]').value;
            const password = document.querySelector('input[name="password"]').value;

            try {
                const response = await fetch('/auth/manual', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();

                if (data.success) {
                    localStorage.setItem('user', JSON.stringify(data.user));
                    window.location.href = '/block';
                } else {
                    const alertBox = document.getElementById('loginAlert');
                    if (alertBox) {
                        alertBox.textContent = data.message || 'Login failed. Please try again.';
                        alertBox.classList.remove('d-none');
                    }
                }
            } catch (error) {
                console.error('Login error:', error);
                const alertBox = document.getElementById('loginAlert');
                if (alertBox) {
                    alertBox.textContent = 'Login failed: ' + error.message;
                    alertBox.classList.remove('d-none');
                }
            }
        });

        // Handles manual register submission (SPA)
        document.getElementById('registerForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const email = document.querySelector('#registerForm input[name="email"]').value;
            const password = document.querySelector('#registerForm input[name="password"]').value;
            const name = document.querySelector('#registerForm input[name="name"]').value;

            try {
                const response = await fetch('/auth/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password, name })
                });
                const data = await response.json();
                if (data.success) {
                    localStorage.setItem('user', JSON.stringify(data.user));
                    window.location.href = '/block';
                } else {
                    const alertBox = document.getElementById('registerAlert');
                    if (alertBox) {
                        alertBox.textContent = data.message || 'Registration failed';
                        alertBox.classList.remove('d-none');
                    }
                }
            } catch (error) {
                const alertBox = document.getElementById('registerAlert');
                if (alertBox) {
                    alertBox.textContent = 'Registration failed: ' + error.message;
                    alertBox.classList.remove('d-none');
                }
            }
        });
        
        // Initialize when page loads
        window.onload = function() {
            initializeGoogleSignIn();
        };
    </script>
 
</body>

</html>